<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Field Report - Satellite Max Zoom + PDF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f6f8fa; color: #232323; }
    .container { max-width: 900px; margin: 0 auto; padding: 24px 8px; }
    h1 { text-align: center; font-size: 2rem; font-weight: 700; margin-bottom: 20px; letter-spacing: 2px; }
    .report-form { background: #fff; border-radius: 16px; box-shadow: 0 2px 10px #0001; padding: 24px; margin-bottom: 32px; display: flex; flex-wrap: wrap; gap: 18px; align-items: flex-start; }
    .report-form input, .report-form textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 1rem; margin-bottom: 8px; }
    .report-form label { font-weight: 600; font-size: 1rem; }
    .form-section { flex: 1 1 220px; min-width: 220px; max-width: 350px; }
    #map { width: 100%; height: 260px; border-radius: 14px; margin-bottom: 10px; }
    .add-btn, .pdf-btn { padding: 10px 22px; border: none; background: #2b7cff; color: #fff; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1.05rem; box-shadow: 0 1px 4px #2b7cff22; transition: background 0.2s; margin-top: 12px;}
    .add-btn:hover, .pdf-btn:hover { background: #175bb6; }
    .item-list { display: grid; gap: 18px; }
    .item-card { background: #fff; border-radius: 14px; box-shadow: 0 1px 8px #0001; display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start; padding: 18px; margin-bottom: 12px; }
    .item-images { display: flex; flex-wrap: wrap; gap: 8px; }
    .item-image { width: 80px; height: 80px; object-fit: cover; border-radius: 10px; background: #eee; }
    .item-info { flex: 1 1 220px; min-width: 160px; }
    .item-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 8px; }
    .item-desc { font-size: 1rem; color: #444; margin-bottom: 10px; }
    .mini-map { width: 160px; height: 100px; border-radius: 10px; margin-top: 10px; }
    .pdf-btn { width: 100%; margin-top: 20px; }
    @media (max-width: 600px) {
      .report-form, .item-card { flex-direction: column; gap: 10px; }
      .item-images, .mini-map { width: 100%; height: 140px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Field Report</h1>
    <form id="itemForm" class="report-form" autocomplete="off">
      <div class="form-section">
        <label for="itemTitle">Item Title</label>
        <input type="text" id="itemTitle" required placeholder="Title...">
        <label for="itemDesc">Description</label>
        <textarea id="itemDesc" rows="3" placeholder="Describe the item"></textarea>
        <label for="itemImg">Images (you can select more than one)</label>
        <input type="file" id="itemImg" accept="image/*" required multiple>
      </div>
      <div class="form-section">
        <label>Click on the map to select location:</label>
        <div id="map"></div>
        <input type="hidden" id="lat">
        <input type="hidden" id="lng">
      </div>
      <div style="flex: 1 1 100%; display: flex; justify-content: flex-end;">
        <button class="add-btn" type="submit">Add Item</button>
      </div>
    </form>
    <h2 style="font-size:1.4rem; margin-bottom: 18px;">Items</h2>
    <div class="item-list" id="itemList"></div>
    <button class="pdf-btn" id="generatePDF">Generate PDF Report</button>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- jsPDF & html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // In-memory items array
    const items = [];

    // Satellite Layer details
    const satelliteLayerURL = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
    const satelliteLayerAttrib = 'Tiles &copy; Esri &mdash; Source: Esri, etc.';

    // --- Map Setup (for adding item) ---
    const map = L.map('map', { zoomControl: true, maxZoom: 19, minZoom: 1 });
    const satelliteLayer = L.tileLayer(satelliteLayerURL, { attribution: satelliteLayerAttrib, maxZoom: 19 }).addTo(map);
    let addMarker = null;

    function setMapToUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 19);
          setMarker(latitude, longitude);
        }, function() {
          map.setView([37.7749, -122.4194], 19);
        });
      } else {
        map.setView([37.7749, -122.4194], 19);
      }
    }

    setMapToUserLocation();

    // Click to choose location
    map.on('click', function(e) {
      setMarker(e.latlng.lat, e.latlng.lng);
    });

    function setMarker(lat, lng) {
      if (addMarker) map.removeLayer(addMarker);
      addMarker = L.marker([lat, lng]).addTo(map);
      document.getElementById('lat').value = lat;
      document.getElementById('lng').value = lng;
    }

    // --- Handle Item Form Submit ---
    document.getElementById('itemForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const title = document.getElementById('itemTitle').value.trim();
      const desc = document.getElementById('itemDesc').value.trim();
      const imgInput = document.getElementById('itemImg');
      const lat = parseFloat(document.getElementById('lat').value);
      const lng = parseFloat(document.getElementById('lng').value);

      if (!title || isNaN(lat) || isNaN(lng) || !imgInput.files.length) {
        alert('Fill all fields and select a location on the map!');
        return;
      }

      // Read all images as data URLs for preview
      const imgDataList = await Promise.all([...imgInput.files].map(file => {
        return new Promise(res => {
          const reader = new FileReader();
          reader.onload = e => res(e.target.result);
          reader.readAsDataURL(file);
        });
      }));

      const item = { title, desc, imgDataList, lat, lng };
      items.push(item);
      renderItems();

      // Reset form and marker
      document.getElementById('itemForm').reset();
      if (addMarker) map.removeLayer(addMarker);
      addMarker = null;
      document.getElementById('lat').value = '';
      document.getElementById('lng').value = '';

      // Recentralize map on user
      setMapToUserLocation();
    });

    // --- Render All Items List ---
    function renderItems() {
      const list = document.getElementById('itemList');
      list.innerHTML = '';
      items.forEach((item, idx) => {
        const card = document.createElement('div');
        card.className = 'item-card';

        // Images
        const imagesDiv = document.createElement('div');
        imagesDiv.className = 'item-images';
        item.imgDataList.forEach(imgData => {
          const img = document.createElement('img');
          img.className = 'item-image';
          img.src = imgData;
          imagesDiv.appendChild(img);
        });
        card.appendChild(imagesDiv);

        // Info
        const info = document.createElement('div');
        info.className = 'item-info';
        info.innerHTML = `
          <div class="item-title">${item.title}</div>
          <div class="item-desc">${item.desc || ''}</div>
          <div style="font-size:0.95em;color:#666;margin-bottom:5px;">
            Lat: ${item.lat.toFixed(6)}, Lng: ${item.lng.toFixed(6)}
          </div>
        `;
        card.appendChild(info);

        // Small map
        const miniMapDiv = document.createElement('div');
        miniMapDiv.className = 'mini-map';
        const miniMapId = 'miniMap_' + Date.now() + '_' + Math.random();
        miniMapDiv.id = miniMapId;
        card.appendChild(miniMapDiv);

        list.appendChild(card);

        // Render mini-map with marker
        setTimeout(() => {
          const miniMap = L.map(miniMapId, {
            zoomControl: false,
            attributionControl: false,
            dragging: false,
            scrollWheelZoom: false,
            doubleClickZoom: false,
            boxZoom: false,
            keyboard: false,
            tap: false,
            preferCanvas: true
          }).setView([item.lat, item.lng], 19);
          L.tileLayer(satelliteLayerURL, { attribution: '' , maxZoom: 19 }).addTo(miniMap);
          L.marker([item.lat, item.lng]).addTo(miniMap);
        }, 50);
      });
    }

    // --- PDF Generation ---
    document.getElementById('generatePDF').addEventListener('click', async function() {
      if (items.length === 0) {
        alert("No items to export!");
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });

      let y = 40;

      for (let [idx, item] of items.entries()) {
        // Title
        doc.setFontSize(16);
        doc.setFont("helvetica", "bold");
        doc.text(item.title, 40, y);

        // Description
        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
        doc.text(item.desc || '', 40, y + 20, {maxWidth: 520});

        // Lat/Lng
        doc.setFontSize(10);
        doc.text(`Location: Lat ${item.lat.toFixed(6)}, Lng ${item.lng.toFixed(6)}`, 40, y + 38);

        // Images
        let imgY = y + 50;
        for (let imgData of item.imgDataList.slice(0, 4)) { // Limit: 4 images per item in PDF for layout
          try {
            doc.addImage(imgData, "JPEG", 40, imgY, 80, 80, undefined, "FAST");
          } catch {}
          imgY += 85;
        }

        // If too close to page bottom, start new page
        y = imgY + 20;
        if (y > 750 || idx === items.length - 1) {
          if (idx !== items.length - 1) {
            doc.addPage();
            y = 40;
          }
        }
      }
      doc.save("FieldReport.pdf");
    });
  </script>
</body>
</html>
