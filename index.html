<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Field Report - Crop Fix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css"/>
  <style>
    body { margin:0; padding:0; font-family:'Segoe UI',Arial,sans-serif; background:#f6f8fa; color:#232323;}
    .container { max-width:900px; margin:0 auto; padding:24px 8px; }
    h1 { text-align:center; font-size:2rem; font-weight:700; margin-bottom:20px; letter-spacing:2px; }
    .report-form { background:#fff; border-radius:16px; box-shadow:0 2px 10px #0001; padding:24px; margin-bottom:32px; display:flex; flex-wrap:wrap; gap:18px; align-items:flex-start; }
    .report-form input, .report-form textarea { width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; font-size:1rem; margin-bottom:8px;}
    .report-form label { font-weight:600; font-size:1rem; }
    .form-section { flex:1 1 220px; min-width:220px; max-width:350px; }
    #map { width:100%; height:260px; border-radius:14px; margin-bottom:10px; }
    .add-btn, .pdf-btn { padding:10px 22px; border:none; background:#2b7cff; color:#fff; border-radius:8px; font-weight:600; cursor:pointer; font-size:1.05rem; box-shadow:0 1px 4px #2b7cff22; transition:background 0.2s; margin-top:12px;}
    .add-btn:hover, .pdf-btn:hover { background:#175bb6; }
    .item-list { display:grid; gap:18px;}
    .item-card { background:#fff; border-radius:14px; box-shadow:0 1px 8px #0001; display:flex; flex-wrap:wrap; gap:20px; align-items:flex-start; padding:18px; margin-bottom:12px;}
    .item-images { display:flex; flex-wrap:wrap; gap:8px;}
    .item-image { width:80px; height:80px; object-fit:cover; border-radius:10px; background:#eee; }
    .item-info { flex:1 1 220px; min-width:160px;}
    .item-title { font-size:1.2rem; font-weight:600; margin-bottom:8px;}
    .item-desc { font-size:1rem; color:#444; margin-bottom:10px;}
    .mini-map { width:160px; height:100px; border-radius:10px; margin-top:10px;}
    .pdf-btn { width:100%; margin-top:20px;}
    @media (max-width:600px) {
      .report-form, .item-card { flex-direction:column; gap:10px; }
      .item-images, .mini-map { width:100%; height:140px; }
    }
    .modal-bg {
      position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.55); display:flex; align-items:center; justify-content:center; z-index:1000;
    }
    .modal-content {
      background:#fff; padding:18px; border-radius:12px; max-width:90vw; max-height:90vh; display:flex; flex-direction:column; align-items:center;
    }
    .modal-images-row { display:flex; gap:16px; flex-wrap:wrap; margin-bottom:10px;}
    .modal-controls { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;}
    .crop-img-preview { max-width:340px; max-height:60vh;}
    .modal-thumb { width:64px; height:64px; object-fit:cover; border-radius:8px; border:2px solid #2b7cff; cursor:pointer;}
    .modal-thumb.selected { border:3px solid #fc0;}
    .modal-thumb.unsaved { filter: grayscale(0.8) blur(1px);}
    .modal-btn { padding:7px 18px; background:#2b7cff; color:#fff; border-radius:7px; border:none; cursor:pointer; font-size:1rem;}
    .modal-btn.delete { background:#e63946;}
    .modal-btn.rotate { background:#8d2cff;}
    .modal-btn.save { background:#26b445;}
    .modal-btn[disabled] { background:#aaa; cursor:not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Field Report</h1>
    <form id="itemForm" class="report-form" autocomplete="off">
      <div class="form-section">
        <label for="itemTitle">Item Title</label>
        <input type="text" id="itemTitle" required placeholder="Title...">
        <label for="itemDesc">Description</label>
        <textarea id="itemDesc" rows="3" placeholder="Describe the item"></textarea>
        <label for="itemImg">Images (you can select more than one)</label>
        <input type="file" id="itemImg" accept="image/*" required multiple>
      </div>
      <div class="form-section">
        <label>Click on the map to select location:</label>
        <div id="map"></div>
        <input type="hidden" id="lat">
        <input type="hidden" id="lng">
      </div>
      <div style="flex:1 1 100%; display:flex; justify-content:flex-end;">
        <button class="add-btn" type="submit">Add Item</button>
      </div>
    </form>
    <h2 style="font-size:1.4rem; margin-bottom:18px;">Items</h2>
    <div class="item-list" id="itemList"></div>
    <button class="pdf-btn" id="generatePDF">Generate PDF Report</button>
  </div>

  <div id="modal-root" style="display:none"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // MAPTILER API KEY
    const MAPTILER_KEY = 'D07LNHRpX8QqmkT39Nza';
    const satelliteLayerURL = `https://api.maptiler.com/maps/hybrid/256/{z}/{x}/{y}.jpg?key=${MAPTILER_KEY}`;
    const satelliteLayerAttrib = '&copy; <a href="https://www.maptiler.com/copyright/" target="_blank">MapTiler</a>';

    const items = [];

    let map = null, addMarker = null, satelliteLayer = null;
    function initMainMap() {
      if (map) { map.remove(); }
      map = L.map('map', { zoomControl:true, maxZoom:20, minZoom:1 });
      satelliteLayer = L.tileLayer(satelliteLayerURL, { attribution: satelliteLayerAttrib, maxZoom:20 });
      satelliteLayer.addTo(map);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          const { latitude, longitude } = pos.coords;
          map.setView([latitude, longitude], 20);
          setMarker(latitude, longitude);
        }, function() {
          map.setView([37.7749, -122.4194], 20);
        });
      } else {
        map.setView([37.7749, -122.4194], 20);
      }
      map.on('click', function(e) { setMarker(e.latlng.lat, e.latlng.lng); });
    }

    function setMarker(lat, lng) {
      if (addMarker) map.removeLayer(addMarker);
      addMarker = L.marker([lat, lng]).addTo(map);
      document.getElementById('lat').value = lat;
      document.getElementById('lng').value = lng;
    }

    window.onload = () => { initMainMap(); };

    document.getElementById('itemImg').addEventListener('change', async function(e) {
      if (!this.files.length) return;
      let imgFiles = Array.from(this.files).map(f => ({ file: f, url: URL.createObjectURL(f) }));
      let croppedImages = await openImageCropModal(imgFiles);
      this.value = '';
      this.croppedImages = Array.isArray(croppedImages) && croppedImages.length ? croppedImages : undefined;
    });

    function openImageCropModal(imgFiles) {
      return new Promise(resolve => {
        const modalRoot = document.getElementById('modal-root');
        modalRoot.style.display = 'flex';
        // Each image gets croppedData and rotation property
        imgFiles = imgFiles.map(f => ({...f, croppedData:null, rotation:0}));

        modalRoot.innerHTML = `
          <div class="modal-bg">
            <div class="modal-content" id="modal-content">
              <div class="modal-images-row" id="modal-thumbs"></div>
              <div><img id="crop-img" class="crop-img-preview" /></div>
              <div class="modal-controls">
                <button class="modal-btn rotate" id="btn-rot-left">&#8634; Rotate Left</button>
                <button class="modal-btn rotate" id="btn-rot-right">&#8635; Rotate Right</button>
                <button class="modal-btn save" id="btn-save">Save</button>
                <button class="modal-btn" id="btn-prev">Prev</button>
                <button class="modal-btn" id="btn-next">Next</button>
                <button class="modal-btn delete" id="btn-delete">Delete</button>
                <button class="modal-btn" id="btn-finish" disabled>Finish</button>
              </div>
              <div id="modal-msg" style="margin-top:8px;color:#e63946;font-size:1.08em;"></div>
            </div>
          </div>
        `;

        let index = 0, cropper = null;

        function updateThumbs() {
          const thumbs = imgFiles.map((img, i) =>
            `<img src="${img.croppedData||img.url}" class="modal-thumb${i === index ? " selected" : ""}${img.croppedData ? '' : ' unsaved'}" data-idx="${i}" title="${img.croppedData?'Saved':'Needs cropping'}" />`
          ).join('');
          document.getElementById('modal-thumbs').innerHTML = thumbs;
          [...document.querySelectorAll('.modal-thumb')].forEach(el => {
            el.onclick = () => { index = +el.dataset.idx; showImage(); };
          });
        }

        function showImage() {
          const img = document.getElementById('crop-img');
          img.src = imgFiles[index].url;
          if (cropper) cropper.destroy();
          img.onload = () => {
            cropper = new Cropper(img, { viewMode:1, autoCropArea:1, rotatable:true });
            cropper.rotate(imgFiles[index].rotation);
          };
          updateThumbs();
          updateFinishButton();
          document.getElementById('modal-msg').textContent = imgFiles[index].croppedData ? "Saved!" : "";
        }

        function updateFinishButton() {
          document.getElementById('btn-finish').disabled = !imgFiles.every(f=>!!f.croppedData);
        }

        document.getElementById('btn-prev').onclick = () => { index = (index-1+imgFiles.length)%imgFiles.length; showImage(); };
        document.getElementById('btn-next').onclick = () => { index = (index+1)%imgFiles.length; showImage(); };
        document.getElementById('btn-delete').onclick = () => {
          if (imgFiles.length === 1) return;
          imgFiles.splice(index,1);
          if (index >= imgFiles.length) index = imgFiles.length-1;
          showImage();
        };
        document.getElementById('btn-rot-left').onclick = () => {
          if (cropper) { cropper.rotate(-90); imgFiles[index].rotation = (imgFiles[index].rotation-90+360)%360; }
        };
        document.getElementById('btn-rot-right').onclick = () => {
          if (cropper) { cropper.rotate(90); imgFiles[index].rotation = (imgFiles[index].rotation+90)%360; }
        };
        document.getElementById('btn-save').onclick = () => {
          if (cropper) {
            imgFiles[index].croppedData = cropper.getCroppedCanvas({ width:600, height:600 }).toDataURL("image/jpeg", 0.85);
            document.getElementById('modal-msg').textContent = "Saved!";
            updateThumbs();
            updateFinishButton();
            setTimeout(()=>{document.getElementById('modal-msg').textContent='';}, 900);
          }
        };
        document.getElementById('btn-finish').onclick = () => {
          if (imgFiles.every(f=>!!f.croppedData)) {
            modalRoot.style.display = 'none';
            resolve(imgFiles.map(f=>f.croppedData));
          }
        };
        showImage();
      });
    }

    document.getElementById('itemForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const title = document.getElementById('itemTitle').value.trim();
      const desc = document.getElementById('itemDesc').value.trim();
      const imgInput = document.getElementById('itemImg');
      const lat = parseFloat(document.getElementById('lat').value);
      const lng = parseFloat(document.getElementById('lng').value);

      let imgDataList = imgInput.croppedImages;
      if (!imgDataList || !imgDataList.length) {
        alert('Add and crop your pictures first!');
        return;
      }
      if (!title || isNaN(lat) || isNaN(lng)) {
        alert('Fill all fields and select a location on the map!');
        return;
      }
      const item = { title, desc, imgDataList, lat, lng };
      items.push(item);
      renderItems();

      document.getElementById('itemForm').reset();
      imgInput.croppedImages = null;
      if (addMarker) map.removeLayer(addMarker);
      addMarker = null;
      document.getElementById('lat').value = '';
      document.getElementById('lng').value = '';
      initMainMap();
    });

    function renderItems() {
      const list = document.getElementById('itemList');
      list.innerHTML = '';
      items.forEach((item, idx) => {
        const card = document.createElement('div');
        card.className = 'item-card';

        const imagesDiv = document.createElement('div');
        imagesDiv.className = 'item-images';
        item.imgDataList.forEach(imgData => {
          const img = document.createElement('img');
          img.className = 'item-image';
          img.src = imgData;
          imagesDiv.appendChild(img);
        });
        card.appendChild(imagesDiv);

        const info = document.createElement('div');
        info.className = 'item-info';
        info.innerHTML = `
          <div class="item-title">${item.title}</div>
          <div class="item-desc">${item.desc || ''}</div>
          <div style="font-size:0.95em;color:#666;margin-bottom:5px;">
            Lat: ${item.lat.toFixed(6)}, Lng: ${item.lng.toFixed(6)}
          </div>
        `;
        card.appendChild(info);

        const miniMapDiv = document.createElement('div');
        miniMapDiv.className = 'mini-map';
        const miniMapId = 'miniMap_' + Date.now() + '_' + Math.random();
        miniMapDiv.id = miniMapId;
        card.appendChild(miniMapDiv);

        list.appendChild(card);

        setTimeout(() => {
          let miniMap = L.map(miniMapId, {
            zoomControl: false,
            attributionControl: false,
            dragging: false,
            scrollWheelZoom: false,
            doubleClickZoom: false,
            boxZoom: false,
            keyboard: false,
            tap: false,
            preferCanvas: true
          }).setView([item.lat, item.lng], 20);
          L.tileLayer(satelliteLayerURL, { attribution: '', maxZoom:20 }).addTo(miniMap);
          L.marker([item.lat, item.lng]).addTo(miniMap);
        }, 100);
      });
    }

    document.getElementById('generatePDF').addEventListener('click', async function() {
      if (items.length === 0) { alert("No items to export!"); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });

      let y = 40;
      for (let [idx, item] of items.entries()) {
        doc.setFontSize(16); doc.setFont("helvetica", "bold"); doc.text(item.title, 40, y);
        doc.setFontSize(12); doc.setFont("helvetica", "normal");
        doc.text(item.desc || '', 40, y+20, {maxWidth: 520});
        doc.setFontSize(10);
        doc.text(`Location: Lat ${item.lat.toFixed(6)}, Lng ${item.lng.toFixed(6)}`, 40, y+38);

        let imgY = y+50;
        for (let imgData of item.imgDataList.slice(0, 4)) {
          try { doc.addImage(imgData, "JPEG", 40, imgY, 80, 80, undefined, "FAST"); } catch {}
          imgY += 85;
        }

        let mapSelector = '.mini-map';
        let mapDivs = document.querySelectorAll(mapSelector);
        let mapDiv = mapDivs[idx];
        let mapImgData = null;
        if (mapDiv) {
          await new Promise(res=>setTimeout(res, 350));
          await html2canvas(mapDiv, {useCORS:true, allowTaint:true, logging:false, width: mapDiv.offsetWidth, height: mapDiv.offsetHeight}).then(canvas=>{
            mapImgData = canvas.toDataURL('image/jpeg',0.9);
            doc.addImage(mapImgData, "JPEG", 140, imgY-85, 130, 80, undefined, "FAST");
          });
        }
        y = imgY + 20;
        if (y > 750 || idx === items.length - 1) { if (idx !== items.length - 1) { doc.addPage(); y = 40; } }
      }
      doc.save("FieldReport.pdf");
    });
  </script>
</body>
</html>
