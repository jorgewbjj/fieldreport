


 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Field Report</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 1rem; }
    h1 { text-align: center; }
    .metadata, .item { border: 1px solid #ccc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .item { background: #fafafa; }
    label { display: block; margin-top: 0.5rem; }
    input, textarea, select, button { width: 100%; padding: 0.5rem; margin-top: 0.25rem; }
    .btn-inline { width: auto; display: inline-block; margin-right: 0.5rem; }
    .item-header { display: flex; justify-content: space-between; align-items: center; }
    .remove-item { background: #e74c3c; color: white; border: none; padding: 0.2rem 0.5rem; border-radius: 4px; cursor: pointer; }
  </style>
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
    import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

    // â”€â”€ YOUR FIREBASE CONFIG â”€â”€
 const firebaseConfig = {
  apiKey: "AIzaSyByxwR_TWiWYMe65G9AxBFgv-_oxX9MThk",
  authDomain: "fieldreport-1c1d2.firebaseapp.com",
  projectId: "fieldreport-1c1d2",
  storageBucket: "fieldreport-1c1d2.firebasestorage.app",
  messagingSenderId: "752765269064",
  appId: "1:752765269064:web:c31c85f245e0c29ba4947d",
  measurementId: "G-18DP7CSDW9"
};

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    // â€” Anonymous Auth so writes donâ€™t get blocked by default rules â€”
    const auth = getAuth(app);
    signInAnonymously(auth)
      .then(() => console.log("âœ… Signed in anonymously"))
      .catch(err => console.error("âŒ Auth error:", err));

    const db = getDatabase(app);
    const storage = getStorage(app);

    document.addEventListener("DOMContentLoaded", () => {
      const itemsContainer = document.getElementById("items");
      const addItemBtn = document.getElementById("add-item");
      const reportForm = document.getElementById("report-form");

      addItem();  // start with one

      addItemBtn.addEventListener("click", e => {
        e.preventDefault();
        addItem();
      });

      reportForm.addEventListener("submit", handleSubmit);

      function addItem() {
        const idx = itemsContainer.children.length;
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="item-header">
            <strong>Item #${idx + 1}</strong>
            <button class="remove-item">Remove</button>
          </div>
          <label>Item Name:
            <input type="text" name="item-name" required />
          </label>
          <label>Location (lat, lng):
            <input type="text" name="item-loc" readonly placeholder="Fetchingâ€¦" />
          </label>
          <label>Description:
            <textarea name="item-desc" rows="2"></textarea>
          </label>
          <label>Pictures:
            <input type="file" name="item-pics" accept="image/*" multiple />
          </label>
        `;
        itemsContainer.appendChild(div);

        // remove
        div.querySelector(".remove-item").addEventListener("click", e => {
          e.preventDefault();
          div.remove();
          Array.from(itemsContainer.children).forEach((it, i) => {
            it.querySelector("strong").textContent = `Item #${i+1}`;
          });
        });

        // geolocation
        const locInput = div.querySelector('[name="item-loc"]');
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            pos => locInput.value = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`,
            err => locInput.value = "Unable to fetch location"
          );
        } else {
          locInput.value = "Geolocation not supported";
        }
      }

      async function handleSubmit(e) {
        e.preventDefault();
        try {
          console.log("ðŸš€ Submitting reportâ€¦");
          const form = e.target;
          const meta = {
            date: form.date.value,
            address: form.address.value,
            store: form.store.value,
            technician: form.technician.value,
            createdAt: Date.now()
          };

          // push new report
          const reportRef = push(ref(db, "reports"));
          console.log("Report ID:", reportRef.key);
          await set(reportRef, meta);
          console.log("âœ… Metadata saved");

          const itemDivs = Array.from(itemsContainer.children);
          for (let i = 0; i < itemDivs.length; i++) {
            const it = itemDivs[i];
            const name = it.querySelector('[name="item-name"]').value;
            const loc  = it.querySelector('[name="item-loc"]').value;
            const desc = it.querySelector('[name="item-desc"]').value;
            const files = it.querySelector('[name="item-pics"]').files;

            const urls = [];
            for (const file of files) {
              const storageRef = sref(storage, `reports/${reportRef.key}/item-${i}/${file.name}`);
              console.log("Uploading", file.name, "to", storageRef.fullPath);
              await uploadBytes(storageRef, file);
              const url = await getDownloadURL(storageRef);
              console.log("URL:", url);
              urls.push(url);
            }

            const itemRef = ref(db, `reports/${reportRef.key}/items/item-${i}`);
            await set(itemRef, { name, loc, desc, pics: urls });
            console.log(`âœ… Item ${i} saved`);
          }

          alert("ðŸ“¥ Report saved!");
          form.reset();
          itemsContainer.innerHTML = "";
          addItem();

        } catch (err) {
          console.error("âŒ Error saving report:", err);
          alert("Error saving report: " + err.message);
        }
      }
    });
  </script>
</head>
<body>
  <h1>Field Report</h1>
  <form id="report-form">
    <div class="metadata">
      <label>Date:
        <input type="date" id="date" name="date" required />
      </label>
      <label>Address:
        <input type="text" id="address" name="address" required placeholder="123 Main St" />
      </label>
      <label>Store:
        <input type="text" id="store" name="store" required placeholder="Store Name or ID" />
      </label>
      <label>Technician:
        <input type="text" id="technician" name="technician" required placeholder="Technician Name" />
      </label>
    </div>

    <div id="items"></div>
    <button id="add-item" class="btn-inline">+ Add Item</button>

    <div style="text-align:center; margin-top:1rem;">
      <button type="submit" style="padding:0.75rem 1.5rem;">Save Report</button>
    </div>
  </form>
</body>
</html>
