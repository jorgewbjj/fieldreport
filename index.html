<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Field Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- MapTiler & Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <!-- jsPDF & html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #f7f9fb;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      background: #fff;
      padding: 28px 20px;
      border-radius: 20px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.06);
    }
    h2 {
      margin-top: 0;
      font-size: 1.6rem;
      font-weight: 700;
      color: #20243a;
    }
    .field-row {
      display: flex;
      gap: 18px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    label {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 4px;
      display: block;
    }
    input, select, button, textarea {
      padding: 10px;
      border: 1px solid #dde3ed;
      border-radius: 8px;
      font-size: 1rem;
      width: 100%;
      margin-top: 2px;
    }
    input[type="date"] { max-width: 170px;}
    select { max-width: 200px; }
    button, .add-btn, .remove-btn {
      cursor: pointer;
      border: none;
      color: #fff;
      background: #377dff;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      transition: background .2s;
    }
    button:hover, .add-btn:hover, .remove-btn:hover { background: #225ec9; }
    .add-btn, .remove-btn {
      background: #31b86a;
      margin-top: 8px;
      margin-bottom: 8px;
      font-size: 0.95rem;
      padding: 5px 12px;
    }
    .remove-btn { background: #e44; margin-left: 14px; }
    .item-section {
      background: #f3f7fa;
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 22px;
      position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }
    .item-section h4 { margin-top: 0; margin-bottom: 10px; }
    .pictures-preview {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .pictures-preview img {
      max-width: 120px;
      max-height: 100px;
      border-radius: 7px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.09);
      object-fit: cover;
    }
    .map-container {
      width: 100%;
      height: 220px;
      margin-top: 7px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    #generatePDF {
      background: #2b9cf6;
      margin-top: 22px;
      width: 100%;
    }
    #addTechPrompt {
      display: none;
      margin-top: 7px;
      gap: 6px;
    }
    #addTechPrompt input { width: auto; flex: 2 1 80px;}
    #allItemsMapForPDF {
      width: 620px;
      height: 300px;
      position: absolute;
      top: -10000px;
      left: -10000px;
      z-index: -1;
      border-radius: 14px;
      overflow: hidden;
      background: #e9e9e9;
      border: 3px solid #eee;
    }
    @media (max-width: 700px) {
      .container { max-width: 98vw; padding: 8vw 2vw; }
      .map-container { height: 160px; }
    }
  </style>
</head>
<body>
  <div class="container" id="reportMain">
    <h2>Field Report</h2>
    <form id="reportForm" autocomplete="off">
      <div class="field-row">
        <div style="flex:1 1 200px">
          <label for="address">Address</label>
          <input type="text" id="address" name="address" required placeholder="Enter address" />
        </div>
        <div style="flex:1 1 150px">
          <label for="date">Date</label>
          <input type="date" id="date" name="date" required />
        </div>
      </div>
      <div class="field-row">
        <div style="flex:1 1 180px">
          <label for="technician">Technician</label>
          <select id="technician" name="technician" required>
            <option value="">Select...</option>
            <option value="Arister">Arister</option>
            <option value="David">David</option>
            <option value="Elias">Elias</option>
            <option value="Wilman">Wilman</option>
            <option value="add-tech">Add technicianâ€¦</option>
          </select>
          <div id="addTechPrompt" style="display: flex; align-items: center;">
            <input type="text" id="addTechInput" placeholder="Technician name"/>
            <button type="button" id="addTechBtn" style="background:#6a4cff; padding: 7px 15px; width:auto;">Add</button>
            <button type="button" id="cancelTechBtn" style="background:#aaa; padding: 7px 12px; width:auto;">Cancel</button>
          </div>
        </div>
        <div style="flex:1 1 180px">
          <label for="store">Store</label>
          <input type="text" id="store" name="store" required />
        </div>
        <div style="flex:1 1 140px">
          <label for="storeNum">Store Number</label>
          <input type="text" id="storeNum" name="storeNum" required />
        </div>
      </div>
      <hr style="margin:30px 0 20px 0; border:none; border-top:1.5px solid #e5e8ef;" />
      <h3 style="margin-bottom:0;">Items</h3>
      <div id="itemsContainer"></div>
      <button type="button" class="add-btn" onclick="addItem()">+ Add Item</button>
      <div style="margin-top:30px;">
        <button type="submit">Submit Report</button>
        <button type="button" id="generatePDF">Generate PDF</button>
      </div>
    </form>
  </div>
  <div id="allItemsMapForPDF"></div>
  <!-- Leaflet & MapTiler JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Set today as default date
    document.getElementById('date').value = (new Date()).toISOString().slice(0,10);
    // Technician Dropdown with Add Feature
    const technicianSelect = document.getElementById('technician');
    const addTechPrompt = document.getElementById('addTechPrompt');
    const addTechInput = document.getElementById('addTechInput');
    const addTechBtn = document.getElementById('addTechBtn');
    const cancelTechBtn = document.getElementById('cancelTechBtn');
    technicianSelect.onchange = function() {
      if (technicianSelect.value === 'add-tech') {
        addTechPrompt.style.display = 'flex';
        addTechInput.focus();
      } else {
        addTechPrompt.style.display = 'none';
      }
    };
    addTechBtn.onclick = function() {
      const name = addTechInput.value.trim();
      if (name) {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        technicianSelect.insertBefore(option, technicianSelect.options[technicianSelect.options.length-1]);
        technicianSelect.value = name;
        addTechPrompt.style.display = 'none';
        addTechInput.value = '';
      }
    };
    cancelTechBtn.onclick = function() {
      addTechPrompt.style.display = 'none';
      technicianSelect.value = '';
    };
    // Items logic
    let itemIdx = 0;
    function addItem() {
      itemIdx++;
      const container = document.getElementById('itemsContainer');
      const div = document.createElement('div');
      div.className = 'item-section';
      div.id = 'item'+itemIdx;
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h4>Item #${itemIdx}</h4>
          <button type="button" class="remove-btn" onclick="removeItem('${div.id}')">Remove</button>
        </div>
        <div class="field-row">
          <div style="flex:2 1 240px">
            <label>Description</label>
            <textarea name="itemDesc${itemIdx}" placeholder="Describe the item..." rows="2" required></textarea>
          </div>
          <div style="flex:1 1 160px">
            <label>Pictures</label>
            <input type="file" name="itemPics${itemIdx}" accept="image/*" multiple onchange="previewPics(this, '${div.id}')"/>
            <div class="pictures-preview" id="picPreview${itemIdx}"></div>
          </div>
        </div>
        <div>
          <label>Item Location on Map</label>
          <div class="map-container" id="map${itemIdx}"></div>
          <input type="hidden" name="itemLat${itemIdx}" id="lat${itemIdx}">
          <input type="hidden" name="itemLng${itemIdx}" id="lng${itemIdx}">
          <div style="margin:7px 0;color:#444; font-size:0.97em;">Selected: <span id="coord${itemIdx}">none</span></div>
        </div>
      `;
      container.appendChild(div);
      initMap('map'+itemIdx, 'lat'+itemIdx, 'lng'+itemIdx, 'coord'+itemIdx);
    }
    function removeItem(id) {
      document.getElementById(id).remove();
    }
    // Image preview
    function previewPics(input, itemDivId) {
      const previewDiv = input.parentElement.querySelector('.pictures-preview');
      previewDiv.innerHTML = '';
      if (input.files) {
        Array.from(input.files).forEach(file => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            previewDiv.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      }
    }
    // MapTiler map logic (uses current position)
    function initMap(mapId, latId, lngId, coordId) {
      const apiKey = "D07LNHRpX8QqmkT39Nza";
      const latInput = document.getElementById(latId);
      const lngInput = document.getElementById(lngId);
      const coordSpan = document.getElementById(coordId);
      function showMap(lat, lng) {
        const map = L.map(mapId, {
          center: [lat, lng],
          zoom: 17,
          zoomControl: true
        });
        L.tileLayer(`https://api.maptiler.com/maps/hybrid/256/{z}/{x}/{y}.jpg?key=${apiKey}`, {
          attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a>',
          tileSize: 256,
          minZoom: 1,
          maxZoom: 20
        }).addTo(map);
        let marker = null;
        if (latInput.value && lngInput.value) {
          marker = L.marker([parseFloat(latInput.value), parseFloat(lngInput.value)]).addTo(map);
          coordSpan.textContent = `${parseFloat(latInput.value).toFixed(6)}, ${parseFloat(lngInput.value).toFixed(6)}`;
        } else {
          marker = L.marker([lat, lng]).addTo(map);
          latInput.value = lat;
          lngInput.value = lng;
          coordSpan.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }
        map.on('click', function(e) {
          const {lat, lng} = e.latlng;
          if (marker) marker.setLatLng(e.latlng);
          else marker = L.marker(e.latlng).addTo(map);
          latInput.value = lat;
          lngInput.value = lng;
          coordSpan.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        });
        setTimeout(() => { map.invalidateSize(); }, 250);
      }
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          showMap(pos.coords.latitude, pos.coords.longitude);
        }, function() {
          showMap(-22.9068, -43.1729);
        });
      } else {
        showMap(-22.9068, -43.1729);
      }
    }
    // PDF generation with all-item map at the end
    document.getElementById('generatePDF').onclick = async function() {
      const jsPDF = window.jspdf.jsPDF;
      const pdf = new jsPDF({ unit: 'px', format: 'a4', orientation: 'portrait' });
      let y = 30, pageHeight = pdf.internal.pageSize.getHeight(), leftMargin = 30;
      const address = document.getElementById('address').value;
      const date = document.getElementById('date').value;
      const tech = document.getElementById('technician').value;
      const store = document.getElementById('store').value;
      const storeNum = document.getElementById('storeNum').value;
      pdf.setFontSize(20);
      pdf.text('Field Report', leftMargin, y);
      y += 24;
      pdf.setFontSize(12);
      pdf.text(`Address: ${address}`, leftMargin, y += 22);
      pdf.text(`Date: ${date}`, 340, y);
      pdf.text(`Technician: ${tech}`, leftMargin, y += 20);
      pdf.text(`Store: ${store}`, leftMargin, y += 20);
      pdf.text(`Store Number: ${storeNum}`, 200, y);
      y += 28;
      pdf.setFontSize(15);
      pdf.text('Items', leftMargin, y);
      y += 10;
      const itemSections = document.querySelectorAll('.item-section');
      const locations = [];
      for (let i = 0; i < itemSections.length; i++) {
        // Estimate space needed for this item
        let estHeight = 24 + 16 + 16 + 10 + 120 + 10; // text and images
        const sec = itemSections[i];
        const desc = sec.querySelector('textarea').value;
        const coord = sec.querySelector('[id^="coord"]').textContent;
        const imgInput = sec.querySelector('input[type="file"]');
        const images = imgInput ? imgInput.files : [];
        const lat = sec.querySelector('[id^="lat"]').value;
        const lng = sec.querySelector('[id^="lng"]').value;
        if(lat && lng) locations.push({lat: parseFloat(lat), lng: parseFloat(lng), num: i+1});
        // Estimate for images
        const nImgs = images.length;
        if (nImgs > 0) {
          estHeight += (Math.ceil(nImgs / 2)) * 120;
        }
        // If not enough space, add a new page
        if (y + estHeight > pageHeight - 50) {
          pdf.addPage();
          y = 30;
        }
        y += 24;
        pdf.setFontSize(13);
        pdf.text(`Item #${i+1}:`, leftMargin, y);
        y += 16;
        pdf.setFontSize(12);
        pdf.text(`Description: ${desc}`, leftMargin+10, y);
        y += 16;
        pdf.text(`Location: ${coord}`, leftMargin+10, y);
        // Pictures (larger, 2 per row, wrap as needed)
        if (images.length) {
          y += 10;
          let ximg = leftMargin+10, imgInRow = 0;
          for (let j = 0; j < images.length; j++) {
            const imgFile = images[j];
            if (imgFile && imgFile.type.startsWith('image/')) {
              try {
                const dataUrl = await fileToDataURL(imgFile);
                pdf.addImage(dataUrl, 'JPEG', ximg, y, 145, 110);
                ximg += 155;
                imgInRow++;
                if (imgInRow === 2) {
                  ximg = leftMargin+10;
                  y += 120;
                  imgInRow = 0;
                  // If not enough space for another row, break page
                  if (y + 120 > pageHeight - 50 && j < images.length - 1) {
                    pdf.addPage();
                    y = 30;
                  }
                }
              } catch (e) {}
            }
          }
          if (imgInRow > 0) y += 120;
        }
        y += 10;
      }
      // All-items map at the end (landscape, centered, smaller, with borders)
      if (locations.length > 0) {
        await generateAllItemsMapPDF(locations, pdf);
      }
      pdf.save(`field-report-${date}.pdf`);
    };
    // File to DataURL
    function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) { resolve(e.target.result); };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    // Generate all-items map and add to PDF
    async function generateAllItemsMapPDF(locations, pdf) {
      return new Promise((resolve) => {
        const mapDiv = document.getElementById('allItemsMapForPDF');
        mapDiv.innerHTML = '';
        mapDiv.style.display = "block";
        if (window._pdfMap && window._pdfMap.remove) window._pdfMap.remove();
        let avgLat = 0, avgLng = 0;
        locations.forEach(l => { avgLat += l.lat; avgLng += l.lng; });
        avgLat /= locations.length;
        avgLng /= locations.length;
        // Map: smaller size, higher zoom, landscape
        const map = L.map('allItemsMapForPDF', {
          center: [avgLat, avgLng],
          zoom: 17,
          zoomControl: false,
          attributionControl: false,
          dragging: false,
          scrollWheelZoom: false,
          doubleClickZoom: false,
          boxZoom: false,
          keyboard: false,
        });
        window._pdfMap = map;
        L.tileLayer(`https://api.maptiler.com/maps/hybrid/256/{z}/{x}/{y}.jpg?key=D07LNHRpX8QqmkT39Nza`, {
          tileSize: 256,
          minZoom: 1,
          maxZoom: 20
        }).addTo(map);
        locations.forEach((l, idx) => {
          const marker = L.marker([l.lat, l.lng]).addTo(map);
          const numberIcon = L.divIcon({
            html: `<div style="background:#2b9cf6;color:#fff;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:18px;border:2px solid #fff;">${l.num}</div>`,
            className: '',
            iconSize: [30,30],
            iconAnchor: [15,15]
          });
          marker.setIcon(numberIcon);
        });
        setTimeout(async () => {
          await html2canvas(mapDiv, {useCORS:true}).then(canvas => {
            map.remove();
            mapDiv.style.display = "none";
            pdf.addPage("a4", "landscape");
            const pageWidth = pdf.internal.pageSize.getWidth();
            pdf.setFontSize(18);
            pdf.text('All Item Locations', pageWidth/2, 40, {align:'center'});
            // Center image (600x300 px in a4 landscape)
            const imgWidth = 600, imgHeight = 300;
            const imgX = (pageWidth-imgWidth)/2;
            pdf.setDrawColor(200);
            pdf.rect(imgX-10, 54, imgWidth+20, imgHeight+20); // Border around image
            pdf.addImage(canvas.toDataURL("image/jpeg", 0.92), 'JPEG', imgX, 64, imgWidth, imgHeight);
            resolve();
          });
        }, 1200);
      });
    }
    // Dummy submit
    document.getElementById('reportForm').onsubmit = function(e) {
      e.preventDefault();
      alert("Report submitted! (Handle save/export logic here)");
    };
  </script>
</body>
</html>
