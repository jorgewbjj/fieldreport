<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Field Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet & Cropper CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css"/>
  <style>
    body { font-family:sans-serif; background:#f6f8fa; color:#232323;}
    .container { max-width:960px; margin:0 auto; padding:24px 8px; }
    h1 { text-align:center; font-size:2rem; margin-bottom:20px; }
    label { font-weight:600; }
    .main-form, .item-form { background:#fff; border-radius:14px; box-shadow:0 2px 10px #0001; padding:18px 18px 6px 18px; margin-bottom:26px;}
    .main-fields { display:grid; grid-template-columns:1fr 1fr 1fr; gap:18px;}
    .main-fields > div { display:flex; flex-direction:column; gap:4px;}
    @media (max-width:800px){ .main-fields {grid-template-columns:1fr 1fr;} }
    @media (max-width:500px){ .main-fields {grid-template-columns:1fr;} }
    input, select, textarea { padding:7px 10px; border-radius:7px; border:1px solid #ccc; font-size:1rem;}
    textarea { resize:vertical; }
    .item-form { margin-top:30px;}
    .item-row { display:flex; flex-wrap:wrap; gap:20px;}
    .item-form label {margin-top:8px;}
    .mapdiv { width:220px; height:160px; border-radius:12px; margin-top:8px;}
    .thumb-row { display:flex; gap:8px; margin-top:7px; }
    .thumb-preview { width:56px; height:56px; object-fit:cover; border-radius:6px; border:2px solid #2b7cff;}
    .item-list { margin-top:26px; }
    .item-card { background:#fff; border-radius:14px; box-shadow:0 1px 8px #0001; display:flex; flex-wrap:wrap; gap:18px; padding:14px; margin-bottom:16px;}
    .item-info { flex:1 1 210px; min-width:150px;}
    .item-map { width:150px; height:105px; border-radius:8px; margin:8px 0 0 0;}
    .btn, .add-btn { padding:8px 20px; border:none; background:#2b7cff; color:#fff; border-radius:7px; font-weight:600; font-size:1rem; margin:8px 8px 8px 0; cursor:pointer;}
    .btn:disabled {background:#bbb;}
    .add-btn {background:#26b445;}
    .modal-bg { position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.65); display:flex; align-items:center; justify-content:center; z-index:1000;}
    .modal-content { background:#fff; padding:18px; border-radius:12px; max-width:92vw; max-height:90vh; display:flex; flex-direction:column; align-items:center;}
    .crop-img-preview { max-width:330px; max-height:60vh; border-radius:10px; box-shadow:0 1px 6px #0002; margin-bottom:16px;}
    .modal-btn { padding:7px 18px; background:#2b7cff; color:#fff; border-radius:7px; border:none; cursor:pointer; font-size:1rem; margin: 2px;}
    .modal-btn.rotate { background:#8d2cff;}
    .modal-btn.done { background:#26b445;}
  </style>
</head>
<body>
<div class="container">
  <h1>Field Report</h1>
  <!-- Main form -->
  <form id="mainForm" class="main-form" autocomplete="off">
    <div class="main-fields">
      <div>
        <label>Address</label>
        <input type="text" id="address" required>
      </div>
      <div>
        <label>Technician</label>
        <div style="display:flex; gap:6px;">
          <select id="technician" style="flex:1">
            <option>Arister</option>
            <option>David</option>
            <option>Elias</option>
            <option value="add_new">+ Add new</option>
          </select>
          <input type="text" id="newTechnician" style="display:none;flex:1" placeholder="New technician...">
        </div>
      </div>
      <div>
        <label>Date</label>
        <input type="date" id="date" required>
      </div>
      <div>
        <label>Store Name</label>
        <input type="text" id="storeName" required>
      </div>
      <div>
        <label>Store Number</label>
        <input type="text" id="storeNumber" required>
      </div>
    </div>
  </form>

  <!-- Item add form -->
  <form id="itemForm" class="item-form">
    <div class="item-row">
      <div style="flex:2;min-width:180px;">
        <label>Item Description</label>
        <textarea id="itemDesc" rows="2" required></textarea>
        <label>Pictures (one or more)</label>
        <input type="file" id="itemImg" accept="image/*" multiple required>
        <div class="thumb-row" id="thumbRow"></div>
      </div>
      <div>
        <label>Location (click on the map)</label>
        <div id="itemMap" class="mapdiv"></div>
        <input type="hidden" id="itemLat">
        <input type="hidden" id="itemLng">
      </div>
    </div>
    <button class="add-btn" id="addItemBtn" type="submit" disabled>Add Item</button>
  </form>

  <!-- Items list -->
  <div class="item-list" id="itemList"></div>
</div>
<div id="modal-root" style="display:none"></div>

<!-- Libraries -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script>
const MAPTILER_KEY = 'D07LNHRpX8QqmkT39Nza';
const satelliteLayerURL = `https://api.maptiler.com/maps/hybrid/256/{z}/{x}/{y}.jpg?key=${MAPTILER_KEY}`;
const satelliteLayerAttrib = '&copy; <a href="https://www.maptiler.com/copyright/" target="_blank">MapTiler</a>';
let technicians = ['Arister', 'David', 'Elias'];
let items = [];
let currentCroppedImages = [];
let itemLatLng = null;

// --- Technician dropdown (add new)
const techSel = document.getElementById('technician');
const newTechInput = document.getElementById('newTechnician');
techSel.onchange = function() {
  if(this.value==='add_new'){
    newTechInput.style.display='block';
    newTechInput.focus();
    this.style.display='none';
  }
};
newTechInput.onblur = function(){
  if(this.value.trim()){
    let name = this.value.trim();
    technicians.push(name);
    let opt = document.createElement('option');
    opt.textContent = name; opt.value = name;
    techSel.insertBefore(opt, techSel.lastElementChild); // before +Add new
    techSel.value = name;
  }
  newTechInput.style.display='none';
  techSel.style.display='block';
};

// --- Date default today
document.getElementById('date').value = new Date().toISOString().split('T')[0];

// --- Item Map for location selection
let itemMap, itemMarker;
function initItemMap() {
  if (itemMap) { itemMap.remove(); }
  itemMap = L.map('itemMap', { zoomControl:true, maxZoom:20, minZoom:1 });
  let tile = L.tileLayer(satelliteLayerURL, { attribution: satelliteLayerAttrib, maxZoom:20 });
  tile.addTo(itemMap);
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(pos) {
      const { latitude, longitude } = pos.coords;
      itemMap.setView([latitude, longitude], 20);
      setItemMarker(latitude, longitude);
    }, function() {
      itemMap.setView([37.7749, -122.4194], 20);
    });
  } else {
    itemMap.setView([37.7749, -122.4194], 20);
  }
  itemMap.on('click', function(e) { setItemMarker(e.latlng.lat, e.latlng.lng); });
}
function setItemMarker(lat, lng) {
  if (itemMarker) itemMap.removeLayer(itemMarker);
  itemMarker = L.marker([lat, lng]).addTo(itemMap);
  itemLatLng = {lat, lng};
  document.getElementById('itemLat').value = lat;
  document.getElementById('itemLng').value = lng;
  updateAddItemBtnState();
}
initItemMap();

// --- Item images (crop, rotate)
document.getElementById('itemImg').addEventListener('change', async function() {
  if (!this.files.length) return;
  let files = Array.from(this.files);
  let croppedArr = [];
  for (let i=0; i<files.length; i++) {
    let cropped = await cropOneImage(files[i]);
    if (!cropped) break;
    croppedArr.push(cropped);
  }
  this.value = '';
  currentCroppedImages = croppedArr;
  showThumbs(croppedArr);
  updateAddItemBtnState();
});
function showThumbs(arr) {
  const thumbRow = document.getElementById('thumbRow');
  thumbRow.innerHTML = arr.map(img=>`<img src="${img}" class="thumb-preview">`).join('');
}
function cropOneImage(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = function(evt) {
      openCropModal(evt.target.result, resolve);
    };
    reader.readAsDataURL(file);
  });
}
function openCropModal(url, callback) {
  const modalRoot = document.getElementById('modal-root');
  modalRoot.style.display = 'flex';
  modalRoot.innerHTML = `
    <div class="modal-bg">
      <div class="modal-content">
        <img id="crop-img" class="crop-img-preview"/>
        <div class="modal-controls">
          <button class="modal-btn rotate" id="btn-rot-left">&#8634; Left</button>
          <button class="modal-btn rotate" id="btn-rot-right">&#8635; Right</button>
          <button class="modal-btn done" id="btn-save">Crop & Save</button>
          <button class="modal-btn" id="btn-cancel">Cancel</button>
        </div>
      </div>
    </div>
  `;
  let cropper;
  const img = document.getElementById('crop-img');
  img.src = url;
  img.onload = function() {
    cropper = new Cropper(img, { viewMode:1, autoCropArea:1, rotatable:true });
  };
  document.getElementById('btn-rot-left').onclick = () => { if (cropper) cropper.rotate(-90); };
  document.getElementById('btn-rot-right').onclick = () => { if (cropper) cropper.rotate(90); };
  document.getElementById('btn-save').onclick = () => {
    if (cropper) {
      let dataUrl = cropper.getCroppedCanvas({ width:600, height:600 }).toDataURL("image/jpeg", 0.87);
      modalRoot.style.display = 'none';
      callback(dataUrl);
    }
  };
  document.getElementById('btn-cancel').onclick = () => {
    modalRoot.style.display = 'none';
    callback(null);
  };
}
function updateAddItemBtnState() {
  const desc = document.getElementById('itemDesc').value.trim();
  document.getElementById('addItemBtn').disabled = !desc || !currentCroppedImages.length || !itemLatLng;
}
document.getElementById('itemDesc').addEventListener('input', updateAddItemBtnState);

// --- Add item (store in array, render list)
document.getElementById('itemForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const desc = document.getElementById('itemDesc').value.trim();
  if (!desc || !currentCroppedImages.length || !itemLatLng) return;
  items.push({
    desc,
    imgDataList: currentCroppedImages,
    lat: itemLatLng.lat,
    lng: itemLatLng.lng
  });
  currentCroppedImages = [];
  itemLatLng = null;
  document.getElementById('itemForm').reset();
  showThumbs([]);
  updateAddItemBtnState();
  initItemMap();
  renderItems();
});
function renderItems() {
  const list = document.getElementById('itemList');
  list.innerHTML = '';
  items.forEach((item, idx) => {
    const card = document.createElement('div');
    card.className = 'item-card';
    const info = document.createElement('div');
    info.className = 'item-info';
    info.innerHTML = `<div><b>Description:</b> ${item.desc}</div>
      <div style="margin:5px 0 8px 0;">${item.imgDataList.map(img=>`<img src="${img}" class="thumb-preview">`).join('')}</div>
      <div style="font-size:0.95em;color:#555;">Lat: ${item.lat.toFixed(6)}, Lng: ${item.lng.toFixed(6)}</div>`;
    card.appendChild(info);
    // Mini map
    const miniMapDiv = document.createElement('div');
    miniMapDiv.className = 'item-map';
    const miniMapId = 'itemMap_' + idx + '_' + Date.now();
    miniMapDiv.id = miniMapId;
    card.appendChild(miniMapDiv);
    list.appendChild(card);
    setTimeout(() => {
      let miniMap = L.map(miniMapId, {
        zoomControl: false, attributionControl: false,
        dragging: false, scrollWheelZoom: false, doubleClickZoom: false, boxZoom: false, keyboard: false, tap: false
      }).setView([item.lat, item.lng], 20);
      L.tileLayer(satelliteLayerURL, { attribution: '', maxZoom:20 }).addTo(miniMap);
      L.marker([item.lat, item.lng]).addTo(miniMap);
    }, 100);
  });
}
</script>
</body>
</html>
