<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Field Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
  <style>
    :root {
      --main: #213559;
      --main-dark: #132040;
      --accent: #38a3ff;
      --bg: #f7f9fb;
      --card: #fff;
      --subtle: #f3f7fa;
      --radius: 18px;
      --shadow: 0 4px 24px rgba(33,53,89,0.08);
    }
    body { font-family: 'Inter', Arial, sans-serif; background: var(--bg); margin: 0; padding: 0; }
    .container {
      max-width: 700px; margin: 32px auto; background: var(--card);
      padding: 2.2rem 7vw 2.2rem 7vw; border-radius: var(--radius);
      box-shadow: var(--shadow); border-top: 8px solid var(--main);
      transition: box-shadow .2s;
    }
    h2 { margin: 0 0 10px 0; font-size: 2rem; font-weight: 800; color: var(--main);
      letter-spacing: -.5px; text-align: center; text-shadow: 0 2px 8px #e2e6ee99;
    }
    #bigLogoWrap { text-align: center; margin-bottom: 12px; }
    #bigLogo { max-width: 240px; width: 98%; margin: 0 auto 12px auto; display: block; filter: drop-shadow(0 2px 8px #22395e22);}
    .logo-row { display: flex; align-items: center; justify-content: center; gap: 18px; margin-bottom: 16px; flex-wrap: wrap; }
    .logo-choice {
      background: #fff; border: 2px solid #a9b8db; border-radius: 10px; padding: 8px 14px; cursor: pointer; font-weight: 700;
      color: #22395e; font-size: 1.08rem; display: flex; align-items: center; gap: 7px; transition: border .18s; box-shadow: 0 2px 8px #23325913;
    }
    .logo-choice.selected { border: 2.5px solid var(--main); color: var(--main-dark); background: #eaf1fd; }
    .logo-choice img { height: 48px; width: auto; vertical-align: middle; filter: drop-shadow(0 1px 5px #22395e21); border-radius: 3px;}
    .info-header-block {
      background: #eaf0fb; border-radius: 13px; border-left: 7px solid var(--main);
      border-top: 1px solid #d7dbed; margin-bottom: 18px; padding: 18px 22px 10px 24px; display: flex; flex-direction: column; gap: 4px;
      max-width: 520px; margin-left: auto; margin-right: auto;
    }
    .info-header-line { display: flex; flex-wrap: wrap; gap: 30px; font-size: 1.08rem; color: #22395e; }
    .info-header-label { font-weight: 700; margin-right: 4px; color: #132040; }
    .info-header-value { font-weight: 500; color: #283659; margin-right: 14px; display: inline-block; }
    .field-row, .roof-row, .addr-row { display: flex; flex-wrap: wrap; gap: 13px; margin-bottom: 12px; }
    .field-col, .roof-col, .addr-col { flex: 1 1 120px; min-width: 110px; }
    .addr-col { min-width: 70px;}
    label { font-size: .99rem; font-weight: 600; margin-bottom: 5px; display: block; color: var(--main-dark);}
    input, select, textarea {
      padding: 10px 12px; border: 1px solid #c5d4ed; border-radius: 8px; font-size: 1rem; width: 100%; margin-top: 2px; background: #fafdff; transition: border .2s;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--main); background: #f0f6ff; }
    input[type="date"] { max-width: 100%; }
    button, .add-btn, .remove-btn {
      cursor: pointer; border: none; color: #fff; background: var(--main); padding: 10px 18px; border-radius: 8px; font-weight: 700; font-size: 1rem; margin-top: 10px; transition: background .2s;
    }
    button:hover, .add-btn:hover, .remove-btn:hover { background: var(--main-dark); }
    .add-btn, .remove-btn { background: var(--accent); margin-top: 10px; padding: 8px 13px; font-size: .97rem; }
    .remove-btn { background: #e44; margin-left: 10px; }
    .item-section {
      background: var(--subtle); border-radius: 12px; padding: 16px 16px 18px 16px; margin-bottom: 17px; position: relative; box-shadow: 0 1px 4px #21355911;
      border-left: 4px solid var(--main-dark);
    }
    .item-header-row { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 6px; margin-bottom: 6px; }
    .item-title { font-weight: 700; font-size: 1.06rem; color: var(--main-dark); margin-right: 12px; }
    .item-desc-inline { font-size: 1.02rem; color: var(--accent); font-weight: 500; max-width: 320px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 1px; }
    .pictures-preview {
      display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 8px;
    }
    .pictures-preview img {
      max-width: 140px; max-height: 105px; border-radius: 9px; box-shadow: 0 1px 6px #1a295b13; object-fit: cover;
      aspect-ratio: 4/3; background: #cbd6e7;
    }
    .map-container {
      width: 100%; height: 160px; margin-top: 7px; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 5px #1a295b07;
    }
    #overviewMapWrap { margin: 30px 0 18px 0; text-align: center;}
    #overviewMapLabel { font-weight: 700; color: #213559; font-size: 1.1em; margin-bottom: 7px; display:block; }
    #overviewMap {
      width: 97%; max-width: 610px; height: 280px; border-radius: 13px; box-shadow: 0 2px 14px #12355911; border: 3px solid #e9e9e9; margin: 0 auto 5px auto; display: block;
    }
    #generatePDF { background: var(--main); margin-top: 18px; width: 100%; padding: 12px; font-size: 1.08rem; }
    #addTechPrompt { display: none; margin-top: 7px; gap: 6px; }
    #addTechPrompt input { width: auto; flex: 2 1 80px;}
    .modal {
      display:none; position:fixed; z-index:99999; left:0; top:0; width:100vw; height:100vh; overflow:auto; background:rgba(22,35,51,0.63); justify-content:center; align-items:center;
    }
    .modal-content { background:#fff; padding:18px 14px 14px 14px; border-radius:14px; box-shadow:0 8px 32px #0003; min-width:300px; max-width:94vw;
      display:flex; flex-direction:column; align-items:center; }
    .modal-actions { margin-top:12px; display:flex; gap:12px;}
    @media (max-width:700px) {
      .container { padding: 8vw 2vw;}
      .item-section {padding:10px;}
      .pictures-preview img {max-width:97px;max-height:72px;}
      #overviewMap {height:160px;}
    }
  </style>
</head>
<body>
  <div class="container" id="reportMain">
    <h2>Field Report</h2>
    <div id="bigLogoWrap">
      <img id="bigLogo" src="seal.png" alt="Logo" />
    </div>
    <div class="logo-row" id="logoRow">
      <div class="logo-choice selected" onclick="selectLogo(this, 'seal')">
        <img src="seal.png" alt="Seal Top" /> Seal Top
      </div>
      <div class="logo-choice" onclick="selectLogo(this, 'ibs')">
        <img src="ibs.png" alt="IBS Roofing" /> IBS Roofing
      </div>
      <div class="logo-choice" onclick="selectLogo(this, 'zurix')">
        <img src="zurix.png" alt="Zurix" /> Zurix
      </div>
      <div class="logo-choice" onclick="selectLogo(this, 'jube')">
        <img src="jube.png" alt="Jube Management" /> Jube Management
      </div>
    </div>
    <form id="reportForm" autocomplete="off">
      <!-- Info summary block -->
      <div class="info-header-block" id="infoHeaderBlock">
        <div class="info-header-line">
          <span class="info-header-label">Store:</span><span class="info-header-value" id="sumStore"></span>
          <span class="info-header-label">Store #:</span><span class="info-header-value" id="sumStoreNum"></span>
          <span class="info-header-label">Technician:</span><span class="info-header-value" id="sumTech"></span>
        </div>
        <div class="info-header-line">
          <span class="info-header-label">Roof:</span><span class="info-header-value" id="sumRoofType"></span>
          <span class="info-header-label">Condition:</span><span class="info-header-value" id="sumRoofCond"></span>
          <span class="info-header-label">Access:</span><span class="info-header-value" id="sumRoofAccess"></span>
        </div>
        <div class="info-header-line">
          <span class="info-header-label">Date:</span><span class="info-header-value" id="sumDate"></span>
        </div>
        <div class="info-header-line">
          <span class="info-header-label">Address:</span>
          <span class="info-header-value" id="sumStreet"></span>
          <span class="info-header-value" id="sumNumber"></span>
          <span class="info-header-value" id="sumCity"></span>
          <span class="info-header-value" id="sumState"></span>
          <span class="info-header-value" id="sumZip"></span>
          <span class="info-header-value" id="sumCountry"></span>
        </div>
      </div>
      <!-- --- FORM FIELDS BELOW --- -->
      <div class="roof-row" style="margin-bottom:10px;">
        <div class="roof-col">
          <label for="roofCondition">Roof Condition</label>
          <select id="roofCondition" required onchange="updateSummary()">
            <option value="">Select...</option>
            <option value="Good">Good</option>
            <option value="Fair">Fair</option>
            <option value="Poor">Poor</option>
          </select>
        </div>
        <div class="roof-col">
          <label for="roofType">Type of Roof</label>
          <select id="roofType" onchange="showOtherRoofType();updateSummary()" required>
            <option value="">Select...</option>
            <option value="PVC">PVC</option>
            <option value="TPO">TPO</option>
            <option value="Modified">Modified</option>
            <option value="Metal">Metal</option>
            <option value="Other">Other</option>
          </select>
          <input type="text" id="roofTypeOther" style="display:none;margin-top:5px;" placeholder="Enter type..." oninput="updateSummary()" />
        </div>
        <div class="roof-col">
          <label for="roofAccess">Roof Access</label>
          <select id="roofAccess" required onchange="updateSummary()">
            <option value="">Select...</option>
            <option value="External ladder">External ladder</option>
            <option value="Roof hatch">Roof hatch</option>
          </select>
        </div>
      </div>
      <div class="addr-row">
        <div class="addr-col"><label for="street">Street</label><input type="text" id="street" required oninput="updateSummary()"/></div>
        <div class="addr-col"><label for="number">Number</label><input type="text" id="number" required oninput="updateSummary()"/></div>
        <div class="addr-col"><label for="city">City</label><input type="text" id="city" required oninput="updateSummary()"/></div>
        <div class="addr-col"><label for="state">State</label><input type="text" id="state" required oninput="updateSummary()"/></div>
        <div class="addr-col"><label for="zip">Zip</label><input type="text" id="zip" required oninput="updateSummary()"/></div>
        <div class="addr-col"><label for="country">Country</label><input type="text" id="country" required oninput="updateSummary()"/></div>
        <div class="addr-col"><label for="date">Date</label><input type="date" id="date" required onchange="updateSummary()"/></div>
      </div>
      <div class="field-row">
        <div class="field-col">
          <label for="technician">Technician</label>
          <select id="technician" name="technician" required onchange="updateSummary()">
            <option value="">Select...</option>
            <option value="Arister">Arister</option>
            <option value="David">David</option>
            <option value="Elias">Elias</option>
            <option value="Wilman">Wilman</option>
            <option value="add-tech">Add technician…</option>
          </select>
          <div id="addTechPrompt" style="display: flex; align-items: center;">
            <input type="text" id="addTechInput" placeholder="Technician name"/>
            <button type="button" id="addTechBtn" style="background:#295ea6; padding: 7px 15px; width:auto;">Add</button>
            <button type="button" id="cancelTechBtn" style="background:#aaa; padding: 7px 12px; width:auto;">Cancel</button>
          </div>
        </div>
        <div class="field-col">
          <label for="store">Store</label>
          <input type="text" id="store" name="store" required oninput="updateSummary()"/>
        </div>
        <div class="field-col">
          <label for="storeNum">Store Number</label>
          <input type="text" id="storeNum" name="storeNum" required oninput="updateSummary()"/>
        </div>
      </div>
      <hr style="margin:20px 0 13px 0; border:none; border-top:1.5px solid #e5e8ef;" />
      <h3 style="margin-bottom:0;font-size:1.10rem;">Items</h3>
      <div id="itemsContainer"></div>
      <button type="button" class="add-btn" onclick="addItem()">+ Add Item</button>
      <!-- OVERVIEW MAP LIVE! -->
      <div id="overviewMapWrap">
        <span id="overviewMapLabel">Overview Map – adjust as you want for the PDF:</span>
        <div id="overviewMap"></div>
      </div>
      <div style="margin-top:18px;">
        <button type="submit">Submit Report</button>
        <button type="button" id="generatePDF">Generate PDF</button>
      </div>
    </form>
  </div>
  <div style="display:none;">
    <div id="allItemsMapForPDF"></div>
  </div>
  <div class="modal" id="cropperModal">
    <div class="modal-content">
      <div style="margin-bottom:8px;font-weight:600;">Crop & Rotate Image</div>
      <img id="cropperImage" style="max-width:96vw;max-height:50vh;">
      <div class="modal-actions">
        <button type="button" onclick="rotateCropper()">Rotate</button>
        <button type="button" onclick="confirmCropper()">OK</button>
        <button type="button" onclick="cancelCropper()">Cancel</button>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Logo options, with local image files
    const logoOptions = {
      seal:  {url: "seal.png",   w: 200, h: 65},
      ibs:   {url: "ibs.png",    w: 200, h: 65},
      zurix: {url: "zurix.png",  w: 200, h: 65},
      jube:  {url: "jube.png",   w: 200, h: 65}
    };
    let selectedLogo = 'seal';
    function selectLogo(el, key) {
      selectedLogo = key;
      document.querySelectorAll('.logo-choice').forEach(e=>e.classList.remove('selected'));
      el.classList.add('selected');
      document.getElementById('bigLogo').src = logoOptions[key].url;
    }
    function showOtherRoofType() {
      var rt = document.getElementById('roofType');
      var rto = document.getElementById('roofTypeOther');
      rto.style.display = (rt.value === 'Other') ? '' : 'none';
      updateSummary();
    }
    document.getElementById('date').value = (new Date()).toISOString().slice(0,10);
    window.onload = function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async function(pos) {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          try {
            const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`;
            const res = await fetch(url, {headers: { 'Accept': 'application/json' }});
            const data = await res.json();
            if (data && data.address) {
              const a = data.address;
              document.getElementById('street').value = a.road||'';
              document.getElementById('number').value = a.house_number||'';
              document.getElementById('city').value = a.city||a.town||a.village||'';
              document.getElementById('state').value = a.state||'';
              document.getElementById('zip').value = a.postcode||'';
              document.getElementById('country').value = a.country||'';
              updateSummary();
            }
          } catch (e) {}
        });
      }
      updateSummary();
      setTimeout(initOverviewMap, 200); // Wait for DOM
    };
    function updateSummary() {
      document.getElementById('sumStore').textContent = document.getElementById('store').value || "";
      document.getElementById('sumStoreNum').textContent = document.getElementById('storeNum').value || "";
      document.getElementById('sumTech').textContent = document.getElementById('technician').value || "";
      let roofType = document.getElementById('roofType').value;
      if (roofType === "Other") roofType = document.getElementById('roofTypeOther').value;
      document.getElementById('sumRoofType').textContent = roofType || "";
      document.getElementById('sumRoofCond').textContent = document.getElementById('roofCondition').value || "";
      document.getElementById('sumRoofAccess').textContent = document.getElementById('roofAccess').value || "";
      document.getElementById('sumDate').textContent = document.getElementById('date').value || "";
      document.getElementById('sumStreet').textContent = document.getElementById('street').value || "";
      document.getElementById('sumNumber').textContent = document.getElementById('number').value || "";
      document.getElementById('sumCity').textContent = document.getElementById('city').value || "";
      document.getElementById('sumState').textContent = document.getElementById('state').value || "";
      document.getElementById('sumZip').textContent = document.getElementById('zip').value || "";
      document.getElementById('sumCountry').textContent = document.getElementById('country').value || "";
      updateOverviewMap();
    }
    // Technician Dropdown with Add Feature
    const technicianSelect = document.getElementById('technician');
    const addTechPrompt = document.getElementById('addTechPrompt');
    const addTechInput = document.getElementById('addTechInput');
    const addTechBtn = document.getElementById('addTechBtn');
    const cancelTechBtn = document.getElementById('cancelTechBtn');
    technicianSelect.onchange = function() {
      updateSummary();
      if (technicianSelect.value === 'add-tech') {
        addTechPrompt.style.display = 'flex';
        addTechInput.focus();
      } else {
        addTechPrompt.style.display = 'none';
      }
    };
    addTechBtn.onclick = function() {
      const name = addTechInput.value.trim();
      if (name) {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        technicianSelect.insertBefore(option, technicianSelect.options[technicianSelect.options.length-1]);
        technicianSelect.value = name;
        addTechPrompt.style.display = 'none';
        addTechInput.value = '';
        updateSummary();
      }
    };
    cancelTechBtn.onclick = function() {
      addTechPrompt.style.display = 'none';
      technicianSelect.value = '';
      updateSummary();
    };
    // Item logic & cropper handling
    let itemIdx = 0;
    function addItem() {
      itemIdx++;
      const container = document.getElementById('itemsContainer');
      const div = document.createElement('div');
      div.className = 'item-section';
      div.id = 'item'+itemIdx;
      div.innerHTML = `
        <div class="item-header-row">
          <span class="item-title">Item #${itemIdx}:</span>
          <span class="item-desc-inline" id="desc-inline-${itemIdx}">(no description yet)</span>
          <button type="button" class="remove-btn" onclick="removeItem('${div.id}')">Remove</button>
        </div>
        <div class="field-row">
          <div style="flex:2 1 200px">
            <label>Description</label>
            <textarea name="itemDesc${itemIdx}" placeholder="Describe the item..." rows="2" required
              oninput="updateDescInline(${itemIdx}, this.value)"></textarea>
          </div>
          <div style="flex:1 1 100px">
            <label>Pictures</label>
            <input type="file" name="itemPics${itemIdx}" accept="image/*" multiple
              onchange="handleImageInput(event, ${itemIdx})" />
            <div class="pictures-preview" id="picPreview${itemIdx}"></div>
          </div>
        </div>
        <div>
          <label>Item Location on Map</label>
          <div class="map-container" id="map${itemIdx}"></div>
          <input type="hidden" name="itemLat${itemIdx}" id="lat${itemIdx}">
          <input type="hidden" name="itemLng${itemIdx}" id="lng${itemIdx}">
          <div style="margin:7px 0;color:#444; font-size:0.97em;">Selected: <span id="coord${itemIdx}">none</span></div>
        </div>
      `;
      container.appendChild(div);
      initMap('map'+itemIdx, 'lat'+itemIdx, 'lng'+itemIdx, 'coord'+itemIdx);
      div.croppedImages = [];
      updateOverviewMap();
    }
    function removeItem(id) {
      document.getElementById(id).remove();
      updateOverviewMap();
    }
    function updateDescInline(idx, value) {
      document.getElementById(`desc-inline-${idx}`).textContent = value.trim() || "(no description yet)";
    }
    // IMAGE CROPPER POPUP LOGIC
    let cropper = null, cropperFile = null, cropperItemId = null, cropperImgs = [], cropperImgsIdx = 0, cropperInput = null;
    async function handleImageInput(e, itemIdx) {
      cropperInput = e.target;
      const files = Array.from(cropperInput.files);
      cropperImgs = files;
      cropperImgsIdx = 0;
      cropperItemId = itemIdx;
      if (files.length > 0) openCropperForFile(files[0]);
    }
    function openCropperForFile(file) {
      const reader = new FileReader();
      reader.onload = function(evt) {
        document.getElementById('cropperImage').src = evt.target.result;
        document.getElementById('cropperModal').style.display = 'flex';
        if (cropper) cropper.destroy();
        cropper = new Cropper(document.getElementById('cropperImage'), {
          aspectRatio: 4 / 3,
          viewMode:1,
          autoCropArea:1
        });
      };
      reader.readAsDataURL(file);
    }
    function rotateCropper() {
      if (cropper) cropper.rotate(90);
    }
    async function confirmCropper() {
      if (!cropper) return;
      const canvas = cropper.getCroppedCanvas({width:1200, height:900, fillColor:'#fff'});
      const dataUrl = canvas.toDataURL("image/jpeg",0.94);
      saveCroppedImgToPreview(dataUrl, cropperItemId);
      cropperImgsIdx++;
      if (cropperImgsIdx < cropperImgs.length) {
        cropper.destroy(); cropper = null;
        openCropperForFile(cropperImgs[cropperImgsIdx]);
      } else {
        cropper.destroy(); cropper = null;
        document.getElementById('cropperModal').style.display = 'none';
      }
    }
    function cancelCropper() {
      if (cropper) cropper.destroy();
      cropper = null;
      document.getElementById('cropperModal').style.display = 'none';
    }
    function saveCroppedImgToPreview(dataUrl, itemIdx) {
      const itemDiv = document.getElementById('item'+itemIdx);
      if (!itemDiv.croppedImages) itemDiv.croppedImages = [];
      itemDiv.croppedImages.push(dataUrl);
      const previewDiv = itemDiv.querySelector('.pictures-preview');
      const img = document.createElement('img');
      img.src = dataUrl;
      previewDiv.appendChild(img);
    }
    // MapTiler map logic (uses current position)
    function initMap(mapId, latId, lngId, coordId) {
      const apiKey = "D07LNHRpX8QqmkT39Nza";
      const latInput = document.getElementById(latId);
      const lngInput = document.getElementById(lngId);
      const coordSpan = document.getElementById(coordId);
      function showMap(lat, lng) {
        const map = L.map(mapId, {center: [lat, lng],zoom: 17,zoomControl: true});
        L.tileLayer(`https://api.maptiler.com/maps/hybrid/256/{z}/{x}/{y}.jpg?key=${apiKey}`, {
          attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a>',
          tileSize: 256,minZoom: 1,maxZoom: 20
        }).addTo(map);
        let marker = null;
        if (latInput.value && lngInput.value) {
          marker = L.marker([parseFloat(latInput.value), parseFloat(lngInput.value)]).addTo(map);
          coordSpan.textContent = `${parseFloat(latInput.value).toFixed(6)}, ${parseFloat(lngInput.value).toFixed(6)}`;
        } else {
          marker = L.marker([lat, lng]).addTo(map);
          latInput.value = lat;
          lngInput.value = lng;
          coordSpan.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }
        map.on('click', function(e) {
          const {lat, lng} = e.latlng;
          if (marker) marker.setLatLng(e.latlng);
          else marker = L.marker(e.latlng).addTo(map);
          latInput.value = lat;
          lngInput.value = lng;
          coordSpan.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        });
        setTimeout(() => { map.invalidateSize(); }, 250);
      }
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          showMap(pos.coords.latitude, pos.coords.longitude);
        }, function() {
          showMap(-22.9068, -43.1729);
        });
      } else {
        showMap(-22.9068, -43.1729);
      }
    }

    // Overview map logic with default center/zoom on item 1
    let overviewMap, overviewMapMarkers = [];
    let overviewMapInitialized = false;
    function initOverviewMap() {
      if (overviewMap) { overviewMap.remove(); overviewMap = null; }
      overviewMap = L.map('overviewMap', { center: [37,-96], zoom: 4, zoomControl: true });
      L.tileLayer('https://api.maptiler.com/maps/hybrid/256/{z}/{x}/{y}.jpg?key=D07LNHRpX8QqmkT39Nza', {
        attribution: '', tileSize: 256, minZoom: 1, maxZoom: 20
      }).addTo(overviewMap);
      overviewMapInitialized = false;
      updateOverviewMap();
    }
    function updateOverviewMap() {
      if (!overviewMap) return;
      overviewMapMarkers.forEach(m=>overviewMap.removeLayer(m));
      overviewMapMarkers = [];
      const itemSections = document.querySelectorAll('.item-section');
      let bounds = [];
      let firstLatLng = null;
      for (let i=0; i<itemSections.length; i++) {
        const sec = itemSections[i];
        const lat = sec.querySelector('[id^="lat"]').value;
        const lng = sec.querySelector('[id^="lng"]').value;
        if (lat && lng) {
          const latNum = parseFloat(lat), lngNum = parseFloat(lng);
          if (!firstLatLng) firstLatLng = [latNum, lngNum];
          bounds.push([latNum, lngNum]);
          let marker = L.marker([latNum, lngNum]);
          const numberIcon = L.divIcon({
            html: `<div style="background:#213559;color:#fff;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:11px;border:2px solid #fff;box-shadow:0 2px 7px #223e5b21;">${i+1}</div>`,
            className: '', iconSize: [18,18], iconAnchor: [9,9]
          });
          marker.setIcon(numberIcon);
          marker.addTo(overviewMap);
          overviewMapMarkers.push(marker);
        }
      }
      // Only auto-center on the first item if the user hasn't interacted yet
      if (!overviewMapInitialized && firstLatLng) {
        overviewMap.setView(firstLatLng, 18);
        overviewMapInitialized = true;
      }
    }

    // PDF GENERATION uses the *current state of the overview map* for the report!
    document.getElementById('generatePDF').onclick = async function() {
      const jsPDF = window.jspdf.jsPDF;
      const pdf = new jsPDF({ unit: 'px', format: 'a4', orientation: 'portrait' });
      let y = 34, pageHeight = pdf.internal.pageSize.getHeight(), leftMargin = 42;
      // Get all fields
      const roofCondition = document.getElementById('roofCondition').value;
      let roofType = document.getElementById('roofType').value;
      if(roofType === "Other") roofType = document.getElementById('roofTypeOther').value;
      const roofAccess = document.getElementById('roofAccess').value;
      const street = document.getElementById('street').value;
      const number = document.getElementById('number').value;
      const city = document.getElementById('city').value;
      const state = document.getElementById('state').value;
      const zip = document.getElementById('zip').value;
      const country = document.getElementById('country').value;
      const date = document.getElementById('date').value;
      const tech = document.getElementById('technician').value;
      const store = document.getElementById('store').value;
      const storeNum = document.getElementById('storeNum').value;
      const logoObj = logoOptions[selectedLogo];
      // --- PDF HEADER WITH LOGO ---
      let logoImage = await getImageDataUrl(logoObj.url);
      const logoDisplayWidth = 220;
      const aspect = logoObj.h / logoObj.w;
      const logoDisplayHeight = logoDisplayWidth * aspect;
      const pageWidth = pdf.internal.pageSize.getWidth();
      const logoX = (pageWidth - logoDisplayWidth) / 2;
      pdf.addImage(logoImage, 'PNG', logoX, y-10, logoDisplayWidth, logoDisplayHeight);
      y += logoDisplayHeight + 16;
      pdf.setFont("helvetica", "bold");
      pdf.setTextColor(33, 53, 89);
      pdf.setFontSize(20);
      pdf.text('Field Report', leftMargin, y);
      y += 10;
      // Neatly left-align info
      pdf.setFontSize(12); pdf.setTextColor(30,30,45); pdf.setFont(undefined, "normal");
      pdf.text(`Store: ${store}  |  Store #: ${storeNum}`, leftMargin, y+=22);
      pdf.text(`Technician: ${tech}`, leftMargin, y+=17);
      pdf.text(`Roof: ${roofType}  |  Condition: ${roofCondition}  |  Access: ${roofAccess}`, leftMargin, y+=17);
      pdf.text(`Date: ${date}`, leftMargin, y+=17);
      pdf.text(`Address: ${street} ${number}, ${city}, ${state} ${zip}, ${country}`, leftMargin, y+=17);
      y += 4;
      pdf.setFontSize(16);
      pdf.setTextColor(33, 53, 89);
      pdf.text('Items', leftMargin, y+=15);
      pdf.setTextColor(40,40,52);
      // --- ITEMS ---
      const itemSections = document.querySelectorAll('.item-section');
      const locations = [];
      for (let i = 0; i < itemSections.length; i++) {
        let sec = itemSections[i];
        let desc = sec.querySelector('textarea').value;
        let imgs = sec.croppedImages || [];
        const coord = sec.querySelector('[id^="coord"]').textContent;
        const lat = sec.querySelector('[id^="lat"]').value;
        const lng = sec.querySelector('[id^="lng"]').value;
        if (lat && lng) locations.push({lat: parseFloat(lat), lng: parseFloat(lng), num: i+1});
        let itemBlockHeight = 90 + (Math.ceil(imgs.length/2) * 135);
        if (y + itemBlockHeight > pageHeight - 60) { pdf.addPage(); y = 38; }
        pdf.setFontSize(14); pdf.setTextColor(33,53,89);
        pdf.text(`Item #${i+1}:`, leftMargin, y+=26);
        pdf.setFontSize(12); pdf.setTextColor(40,40,52);
        pdf.text(desc, leftMargin+62, y-2);
        pdf.text(`Location: ${coord}`, leftMargin, y+=18);
        let imgY = y+4, imgX = leftMargin, imgWidth = 180, imgHeight = 135, gapX = 18;
        for (let j = 0; j < imgs.length; j += 2) {
          if (imgY+imgHeight > pageHeight-60) { pdf.addPage(); imgY = 38; }
          for (let k = 0; k < 2 && j+k < imgs.length; k++) {
            pdf.addImage(imgs[j+k], 'JPEG', imgX+(k*(imgWidth+gapX)), imgY, imgWidth, imgHeight);
          }
          imgY += imgHeight+12;
        }
        y = imgY+2;
      }
      // --- OVERVIEW MAP (snapshot from live map) ---
      if (locations.length > 0) await generateAllItemsMapPDF_fromLive(overviewMap, pdf);
      pdf.save(`field-report-${date}.pdf`);
    };
    function getImageDataUrl(url) {
      return new Promise(res=>{
        let img = new window.Image();
        img.crossOrigin = "Anonymous";
        img.onload = function() {
          let canvas = document.createElement('canvas');
          canvas.width = img.width; canvas.height = img.height;
          let ctx = canvas.getContext('2d');
          ctx.drawImage(img,0,0);
          res(canvas.toDataURL());
        };
        img.src = url;
      });
    }
    // Overview map snapshot logic:
    async function generateAllItemsMapPDF_fromLive(map, pdf) {
      return new Promise((resolve) => {
        const container = map.getContainer();
        setTimeout(async () => {
          await html2canvas(container, {useCORS:true, backgroundColor:null}).then(canvas => {
            pdf.addPage("a4", "landscape");
            const pageWidth = pdf.internal.pageSize.getWidth();
            pdf.setFontSize(18);
            pdf.text('All Item Locations', pageWidth/2, 40, {align:'center'});
            const imgWidth = 540, imgHeight = 260;
            const imgX = (pageWidth-imgWidth)/2;
            pdf.setDrawColor(90,110,150);
            pdf.rect(imgX-10, 54, imgWidth+20, imgHeight+20);
            pdf.addImage(canvas.toDataURL("image/jpeg", 0.94), 'JPEG', imgX, 64, imgWidth, imgHeight);
            resolve();
          });
        }, 500);
      });
    }
    document.getElementById('reportForm').onsubmit = function(e) {
      e.preventDefault();
      alert("Report submitted! (Handle save/export logic here)");
    };
  </script>
</body>
</html>
